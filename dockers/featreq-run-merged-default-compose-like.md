# Feature Request: Make run-merged.sh default behavior match `docker compose up stage-2`

## Motivation and current behavior
- Today, `run-merged.sh` works fine in the foreground (non-`-d`) because it blocks and you see logs. However, when started in the background (`-d`) without a TTY/STDIN, the container can exit immediately because the entrypoint ultimately starts an interactive shell.
- By contrast, `docker compose up stage-2` (as generated by the template) sets `tty: true` and `stdin_open: true`, so even in detached mode the container keeps running.
- Expected UX:
  1) The default behavior of `run-merged.sh` should match `docker compose up stage-2` (compose-like): foreground blocks and allocates TTY/STDIN; detached mode still keeps TTY/STDIN so the container does not “instant-exit”.
  2) Only when explicitly requested via CLI should we “enter shell directly” (akin to `docker run -it`).

## Goals and desired behavior
- Default (no extra flags): compose-like behavior
  - Foreground: block and allocate `-it` (equivalent to compose’s `tty: true` + `stdin_open: true`).
  - Detached (`-d`): still allocate `-it` (or `-t` and `-i` separately) to keep the container alive even if the entrypoint drops into an interactive shell.
- Explicit shell mode: a CLI flag to intentionally start an interactive shell (similar to `docker run -it`). If a custom command is provided after `--`, that command takes precedence.

## Proposed CLI/UX
- Keep existing flags: `-d/--detach`, `-n/--name`, `-p/--publish`, `-v/--volume`, `--gpus`, etc.
- Add/adjust:
  - `--shell`: force an interactive shell (default `/bin/bash -l`), ignoring the default CMD. If a command is provided via `-- CMD ARGS...`, use that instead of the default shell.
  - `--no-tty`: explicitly disable TTY/STDIN allocation (rare; default is enabled).
  - Optional finer controls:
    - `--stdin-open/--no-stdin-open` (maps to compose’s `stdin_open`)
    - `--tty/--no-tty` (maps to compose’s `tty`)

## Defaults and env vars (`merged.env`)
- Keep and extend existing keys:
  - `RUN_DETACH='0'`, `RUN_TTY='1'`, `RUN_DEVICE_TYPE='gpu'`, `RUN_PORTS=...`, etc.
  - New keys (proposed):
    - `RUN_STDIN_OPEN='1'`: whether to pass `-i` to `docker run` (default 1, matches compose).
    - `RUN_KEEP_TTY_IN_DETACH='1'`: keep `-t/-i` even when `-d` is used (default 1).
- Compatibility: keep `RUN_EXTRA_ARGS` for advanced cases; users no longer need to set `-it` there to avoid background exits.

## Implementation outline (run-merged.sh)
1) Parse and normalize the new env vars:
   ```bash
   STDIN_OPEN=$(normalize_bool "${RUN_STDIN_OPEN:-1}")
   KEEP_TTY_IN_DETACH=$(normalize_bool "${RUN_KEEP_TTY_IN_DETACH:-1}")
   ```
2) Build the docker run command with compose-like TTY/STDIN logic:
   ```bash
   cmd=( docker run )
   if [[ "$DETACH" == "1" ]]; then
     cmd+=( -d )
     # Compose-like: keep -t/-i in detached mode (can be disabled by --no-tty or KEEP_TTY_IN_DETACH=0)
     if [[ "$KEEP_TTY_IN_DETACH" == "1" ]]; then
       [[ "$TTY" == "1" ]] && cmd+=( -t )
       [[ "$STDIN_OPEN" == "1" ]] && cmd+=( -i )
     fi
   else
     # Foreground: default to -it
     [[ "$TTY" == "1" ]] && cmd+=( -t )
     [[ "$STDIN_OPEN" == "1" ]] && cmd+=( -i )
   fi
   ```
3) Add a `--shell` flag:
   ```bash
   SHELL_MODE=0
   # during arg parsing:
   --shell) SHELL_MODE=1; shift ;;
   # when assembling the final CMD:
   if [[ $SHELL_MODE -eq 1 && ${#POSITIONAL[@]} -eq 0 ]]; then
     POSITIONAL=( "/bin/bash" "-l" )
   fi
   ```
4) Optionally implement `--no-tty`, `--tty`, `--stdin-open/--no-stdin-open` for fine-grained control.
5) Update `usage()` to explicitly state: “default is compose-like; use `--shell` to explicitly open an interactive shell”.

## Compatibility and migration
- Backwards-compatible with existing flags and `merged.env`.
- Safer defaults: fewer users hit the “container exits immediately in -d mode” pitfall.
- For workloads that truly require no TTY/STDIN in detached mode, users can set `--no-tty` or configure `RUN_TTY='0' RUN_STDIN_OPEN='0'` in `merged.env`.

## Testing checklist
- Foreground default (no flags): blocks, prints entry logs, terminates with Ctrl+C.
- Detached `-d`: container remains running; `docker logs -f` shows the same logs.
- `--shell`: opens `/bin/bash -l` when no command is provided; if `-- CMD` is present, runs CMD instead.
- `--no-tty`: verify no `-t/-i` is added and confirm behavior per entrypoint/CMD.

## Docs to update
- Update `dockers/README.md` to clarify the new defaults (compose-like in both foreground and detached modes).
- Add `--shell` examples so users don’t rely on `RUN_EXTRA_ARGS='-it'` anymore.

## Suggested development steps
- [ ] Implement the new flags and default logic in `run-merged.sh`.
- [ ] Add `RUN_STDIN_OPEN` and `RUN_KEEP_TTY_IN_DETACH` to `merged.env` with defaults set to 1.
- [ ] Update usage text and examples.
- [ ] Validate locally: foreground, detached, `--shell`, `--no-tty`, GPU/CPU.
- [ ] Update `dockers/README.md` accordingly and commit.

---
With these changes, `run-merged.sh` will behave like `docker compose up stage-2` by default and provide a clear, explicit `--shell` path for users who want to jump directly into an interactive shell. This reduces surprises for new users while preserving power-user flexibility.
